# This workflow deploys a Node.js project to GitHub Pages using the official actions/deploy-pages action
# Requires uploading build artifacts and follows GitHub's standardized deployment流程

name: Node.js CI & GitHub Pages Deploy

on:
  push:
    branches: ["main"]  # 推送到 main 分支触发部署
  pull_request:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      pages: write      # 必需：部署到 Pages 的权限
      actions: write  # 必需：上传工件的权限
    environment:
      name: github-pages
    strategy:
      matrix:
        node-version: ["22.x"]  # 使用 Node.js 22.x（LTS 版本）

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 拉取完整历史（用于 Git 信息）

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: "pnpm"   # 缓存 pnpm 依赖

    - name: Set up pnpm
      uses: pnpm/action-setup@v4.1.0
      with:
        version: 10.6.1  # 指定 pnpm 版本
        cache: true       # 启用 pnpm 缓存

    - name: Install dependencies
      run: pnpm install  # 安装依赖

    - name: Build project
      run: pnpm run build  # 执行构建（输出到 dist 目录，需与实际项目一致）

    - name: Upload deployment artifact  # 必需步骤：上传构建产物到工件
      uses: actions/upload-artifact@v4
      with:
        name: github-pages  # 固定名称，与 deploy-pages 动作匹配
        path: ./dist        # 构建输出目录（确保与 build 步骤输出一致）
        retention-days: 30  # 工件保留天数（可选）

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      # 无需额外配置，默认使用名为 "github-pages" 的工件和 GITHUB_TOKEN    
